# 基础格式

<cite>
**本文档引用文件**  
- [main.py](file://main.py#L1322-L1710)
</cite>

## 目录
1. [基础格式功能概述](#基础格式功能概述)
2. [悬浮工具栏创建过程](#悬浮工具栏创建过程)
3. [标题子菜单的循环生成逻辑](#标题子菜单的循环生成逻辑)
4. [格式按钮的批量创建方式](#格式按钮的批量创建方式)
5. [插入操作的光标控制机制](#插入操作的光标控制机制)
6. [快捷键显示与用户交互流程](#快捷键显示与用户交互流程)
7. [特殊处理细节](#特殊处理细节)
8. [扩展新格式按钮的方法](#扩展新格式按钮的方法)

## 基础格式功能概述

悬浮工具栏中的基础格式功能允许用户通过"📝 基础"菜单快速插入Markdown标题（H1-H6）和文本格式（粗体、斜体、删除线、高亮、行内代码）。该功能通过`FloatingMarkdownToolbar`类实现，提供了直观的图形界面来简化Markdown语法的输入过程。

**Section sources**
- [main.py](file://main.py#L1322-L1333)

## 悬浮工具栏创建过程

在`FloatingMarkdownToolbar`类的`init_ui`方法中，通过创建菜单按钮和关联菜单的方式构建基础格式功能。`_create_menu_button`方法用于创建带有图标的菜单按钮，而`_create_menu`方法则创建下拉菜单。整个工具栏采用水平布局（`QHBoxLayout`），将多个功能菜单并列排列。

**Section sources**
- [main.py](file://main.py#L1435-L1438)

## 标题子菜单的循环生成逻辑

标题子菜单的创建采用了循环生成的方式，通过`for`循环遍历1到6的数字，为每个标题级别创建相应的菜单项：

```python
header_menu = basic_menu.addMenu("🅽 标题")
for i in range(1, 7):
    action = header_menu.addAction(f"H{i} - {'#'*i} 标题{i}")
    action.triggered.connect(lambda c, l=i: self.insert_header(l))
```

这种循环生成方式避免了重复代码，使H1到H6标题的创建更加简洁高效。每个菜单项的文本显示为"H1 - # 标题1"到"H6 - ###### 标题6"的格式，清晰地展示了不同级别的标题效果。

**Section sources**
- [main.py](file://main.py#L1444-L1447)

## 格式按钮的批量创建方式

文本格式按钮采用批量创建的方式，通过定义`format_items`列表来统一管理所有格式选项：

```python
format_items = [
    ("🅱️ 粗体", "**", "**", "Ctrl+B"),
    ("🅸️ 斜体", "*", "*", "Ctrl+I"),
    ("S̶ 删除线", "~~", "~~", "Ctrl+D"),
    ("🟡 高亮", "==", "==", "Ctrl+H"),
    ("💻 行内代码", "`", "`", "Ctrl+`")
]
for text, prefix, suffix, shortcut in format_items:
    action = basic_menu.addAction(f"{text}  {shortcut}")
    action.triggered.connect(lambda c, p=prefix, s=suffix: self.insert_format(p, s))
```

这种方式将格式的显示文本、前缀标记、后缀标记和快捷键信息集中管理，便于维护和扩展。通过循环遍历`format_items`列表，动态创建每个格式的菜单项，并将相应的标记前缀和后缀传递给`insert_format`方法。

**Section sources**
- [main.py](file://main.py#L1452-L1461)

## 插入操作的光标控制机制

### 标题插入方法

`insert_header`方法负责处理标题的插入操作：

```python
def insert_header(self, level):
    editor = self.get_editor()
    if not editor:
        return
    cursor = editor.textCursor()
    line_text = cursor.selectedText()
    cleaned = re.sub(r'^#+\s*', '', line_text)
    new_text = '#' * level + ' ' + cleaned
    cursor.insertText(new_text)
    cursor.movePosition(QTextCursor.MoveOperation.EndOfLine)
    editor.setTextCursor(cursor)
    editor.setFocus()
```

该方法首先获取当前编辑器和光标位置，然后检查是否有选中文本。如果有选中内容，会使用正则表达式`re.sub(r'^#+\s*', '', line_text)`自动清理已有的标题标记，确保不会出现多重标题标记。然后根据指定的级别插入相应数量的井号（#）和空格，最后将光标移动到行尾。

### 格式化文本插入方法

`insert_format`方法处理各种文本格式的插入：

```python
def insert_format(self, prefix, suffix):
    editor = self.get_editor()
    if not editor:
        return
    cursor = editor.textCursor()
    if cursor.hasSelection():
        selected = cursor.selectedText()
        cursor.insertText(f"{prefix}{selected}{suffix}")
    else:
        cursor.insertText(f"{prefix}{suffix}")
        cursor.movePosition(QTextCursor.MoveOperation.Left, QTextCursor.MoveMode.MoveAnchor, len(suffix))
        editor.setTextCursor(cursor)
    editor.setFocus()
```

当有文本被选中时，方法会将选中的文本包裹在指定的格式标记中；如果没有选中任何文本，则插入成对的格式标记，并将光标定位在前缀和后缀之间，方便用户直接输入内容。

**Section sources**
- [main.py](file://main.py#L1683-L1708)

## 快捷键显示与用户交互流程

在菜单项的创建过程中，快捷键信息被直接整合到菜单项的显示文本中：

```python
action = basic_menu.addAction(f"{text}  {shortcut}")
```

这种方式在菜单中直观地显示了每个功能对应的快捷键，帮助用户学习和记忆。系统还通过`setup_shortcuts`方法在主窗口中注册了全局快捷键，使得用户既可以通过点击工具栏使用功能，也可以通过键盘快捷键快速操作。

用户交互流程如下：当用户点击编辑器时，如果启用了自动显示功能，悬浮工具栏会自动出现；用户可以点击"📝 基础"按钮展开菜单，然后选择所需的标题级别或文本格式；选择后，相应的Markdown语法会被插入到光标位置或选中文本周围。

**Section sources**
- [main.py](file://main.py#L1931-L1985)

## 特殊处理细节

### 标题插入时的标记清理

标题插入时的一个重要细节是自动清理已有标记的功能。通过正则表达式`re.sub(r'^#+\s*', '', line_text)`，系统会移除选中文本开头的所有井号（#）和跟随的空格，确保不会产生如"### ### 标题"这样的重复标记，保持Markdown语法的规范性。

### 选中文本的格式化处理

对于格式化操作，系统会智能判断是否有文本被选中。如果有选中内容，则将格式标记应用到选中的文本上；如果没有选中任何内容，则插入成对的标记并调整光标位置，使用户能够立即开始输入需要格式化的文本。

### 光标定位优化

在插入成对的格式标记后，系统会使用`cursor.movePosition(QTextCursor.MoveOperation.Left, QTextCursor.MoveMode.MoveAnchor, len(suffix))`将光标向左移动，定位在前缀和后缀之间，提供良好的用户体验。

**Section sources**
- [main.py](file://main.py#L1685-L1687)
- [main.py](file://main.py#L1701-L1706)

## 扩展新格式按钮的方法

要添加新的格式按钮，可以按照以下步骤进行：

1. 在`format_items`列表中添加新的格式项，包含显示文本、前缀、后缀和快捷键
2. 确保新的格式标记符合Markdown语法规范
3. 如果需要，可以在`setup_shortcuts`方法中添加相应的全局快捷键

例如，要添加"下划线"格式，可以这样扩展：

```python
format_items = [
    # ... existing items ...
    ("___ 下划线", "<u>", "</u>", "Ctrl+U")  # 新增项
]
```

然后在`setup_shortcuts`方法中添加：
```python
underline_shortcut = QShortcut(QKeySequence("Ctrl+U"), self)
underline_shortcut.activated.connect(lambda: self.insert_markdown_wrapper("<u>", "</u>"))
```

这种模块化的设计使得添加新格式变得简单而一致。

**Section sources**
- [main.py](file://main.py#L1452-L1458)
- [main.py](file://main.py#L1931-L1996)